<html>
 <head>
 <style type="text/css">
 #canvas{
 	border:1px solid #000;
  margin-left: 200px;
 }
 </style>
 <script src="jquery.js"></script>
 </head>
 <body >
   <canvas id="canvas" width="600" height="600"></canvas>
   <style>
   div{
    width: 50px;
    height: 50px;
    
   }
  .up{
    position: absolute;
    left: 50px;
    top: 0;
    background-color: red;
  }.down{
    position: absolute;
    left: 50px;
    top: 50px;
    background: blue;
  }.left{
    position: absolute;
    left: 0px;
    top: 50px;
    background: yellow;
  }.right{
    position: absolute;
    left: 100px;
    top: 50px;
    background: black;
  }
  .stop{
    position: absolute;
    left: 100px;
    top: 250px;
    background: red;
  }
  .start{
    position: absolute;
    left: 100px;
    top: 200px;
    background: green;
  }
   </style>
   <div class="up"></div>
   <div class="down"></div>
   <div class="left"></div>
   <div class="right"></div>
   <div class="stop">stop</div>
   <div class="start">start</div>
  
   <script type="application/x-javascript">
var border = 29;//边界
var broad = [border,border];
var points = [
  [2,1],
  [1,1],
  [0,1]
];
var moves = ['addX','addX','addX'];
var candy = [[4,4]];

var stopFlag = true;


function makeCandy(){
  if(candy.length>5){
    return;
  }
  var x = Math.ceil(Math.random()*border);
  var y = Math.ceil(Math.random()*border);
  var canPushFlag = 1;
  var arr = [x,y];
  for (var i = 0; i < points.length; i++) {
    if(points[i][0] == x && points[i][1] == y){
      canPushFlag = 0;
    }
  }

  if(canPushFlag){
    candy.push([x,y]);
  }
}

function isInCandy(arr){
  var inCandy = false;
   for (var i = 0; i < candy.length; i++) {
    if(candy[i][0] == arr[0] && candy[i][1] == arr[1]){
      inCandy = true;
      candy.splice(i,1);
    }
  }
  return inCandy;
}

var action = {
    addX:function(arr){
      return [++arr[0],arr[1]];
    },
    reduceX:function(arr){
      return [--arr[0],arr[1]];
    },
    addY:function(arr){
      return [arr[0],++arr[1]];
    },
    reduceY:function(arr){
      return [arr[0],--arr[1]];
    }
}

var nextMove = '';
var moveFlag = 0;
var per=20;
var eatCandy = false;//是否吃糖


var tt;
function round(){
  //到某一时刻的一瞬间，判断此时有效的行为。无特殊行为则复制上一行为。up,down,left,right
  //然后移动snake
  //判断，目标点 是否存在 candy 或者 禁区 或者本身
  //如果是candy 则跳过pop一步。
  movesF();
  var lastarr = [points[points.length - 1][0],points[points.length - 1][1]];
  for(var i = 0;i < points.length;i++){
    points[i] = action[moves[i]](points[i]);
  }
  if(isInCandy(points[0])){
    eatCandy = true;//吃了一个糖
  }
  if(eatCandy){
    points.push(lastarr);
  }
  draw();

  tt = setTimeout(function(){
    if(stopFlag){
      return;
    }
    round();
    if(tt % 5 ==0){
      makeCandy();
    }
  },300);
}

function movesF(){
  if(!eatCandy){//没吃糖
    moves.pop();
  }else{//吃了糖
    eatCandy = false;
  }
  if(moveFlag){
    moves.unshift(nextMove);
    moveFlag=0;
  }else{
    moves.unshift(moves[0]);
  }
}
function validate(str){

}


$('div').click(function(event) {
  var ele = event.currentTarget;
  if($(ele).hasClass('up')){
    if(moves[0] != 'addY'){
      nextMove = 'reduceY';
      moveFlag = 1;
    }
  }else if($(ele).hasClass('down')){
    if(moves[0] != 'reduceY'){
      nextMove = 'addY';
      moveFlag = 1;
    }
  }else if($(ele).hasClass('left')){
    if(moves[0] != 'addX'){
      nextMove = 'reduceX';
      moveFlag = 1;
    }
  }else if($(ele).hasClass('right')){
    if(moves[0] != 'reduceX'){
      nextMove = 'addX';
      moveFlag = 1;
    }
  }else{
    moveFlag = 0;
  }
  // round();
});

$(document).keydown(function(e) {
  e=window.event||e;
  switch(e.which){
    case 32: //暂停
      if(stopFlag){
        $('.start').trigger('click');
      }else{
        $('.stop').trigger('click');
      }
      break;
    case 37: //左键
      $('.left').trigger('click');
      break;
    case 38: //向上键
      $('.up').trigger('click');
      break;
    case 39: //右键
      $('.right').trigger('click');
      break;
    case 40: //向下键
      $('.down').trigger('click');
      break;
    default:
      break;
  }
});

$('.start').click(function(event) {
  if(stopFlag){
    round();
    stopFlag = false;  
  }
});

$('.stop').click(function(event) {
  stopFlag = true;
});

function draw(){
  var canvas = document.getElementById("canvas");
  if (canvas.getContext){
    var ctx = canvas.getContext('2d');
    var width = $('#canvas').width();
    var height = $('#canvas').height();
    ctx.clearRect(0,0,width,height);
    for (var i = 0; i < points.length; i++) {
      ctx.strokeStyle="#000000";
      ctx.strokeRect(points[i][0]*per,points[i][1]*per,per,per);
    }
    for (var i = 0; i < candy.length; i++) {
      ctx.strokeStyle="#FF0000";
      ctx.strokeRect(candy[i][0]*per,candy[i][1]*per,per,per);
    }
  }
}


  </script>
 </body>
</html>